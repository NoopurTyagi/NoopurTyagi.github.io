<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLTF Viewer with Navigation (Three.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.145.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.145.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.145.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
  <h1>3D Model for Navigation</h1>
  <div id="waypoints" style="position: fixed; top: 0; right: 0; background: rgba(255, 255, 255, 0.8); padding: 10px;">
    <h2>Waypoints</h2>
    <ul id="waypoint-list"></ul>
  </div>
  <div id="selected-waypoints" style="position: fixed; bottom: 0; left: 0; background: rgba(255, 255, 255, 0.8); padding: 10px;">
    <h2>Selected Waypoints</h2>
    <p>Start Waypoint: <span id="start-waypoint">None</span></p>
    <p>End Waypoint: <span id="end-waypoint">None</span></p>
  </div>

  <script>
    const waypoints = [
      {
        "id": 1,
        "name": "Entrance",
        "x": 76.6602765128,
        "y": 30.5161517423,
        "z": 0,
        "connected": [2]
      },
      {
        "id": 2,
        "name": "Corridor Intersection",
        "x": 76.6603059784,
        "y": 30.5161504406,
        "z": 0,
        "connected": [1, 3, 4, 5, 6, 7]
      },
      {
        "id": 3,
        "name": "Faculty Room 03",
        "x": 76.66029749,
        "y": 30.51619241,
        "z": 0,
        "connected": [2]
      },
      {
        "id": 4,
        "name": "Faculty Room 004",
        "x": 76.66032369,
        "y": 30.51611387,
        "z": 0,
        "connected": [2]
      },
      {
        "id": 5,
        "name": "Restroom 1",
        "x": 76.66032721,
        "y": 30.51619371,
        "z": 0,
        "connected": [2]
      },
      {
        "id": 6,
        "name": "Restroom 2",
        "x": 76.66034232,
        "y": 30.51619154,
        "z": 0,
        "connected": [2]
      },
      {
        "id": 7,
        "name": "Pantry",
        "x": 76.66034686,
        "y": 30.51617505,
        "z": 0,
        "connected": [2]
      }
    ];

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, 10);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.25;
    controls.screenSpacePanning = false;
    controls.maxPolarAngle = Math.PI / 2;

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(5, 10, 7.5).normalize();
    scene.add(directionalLight);

    let waypointMap = {};
    let markers = [];
    let lines = [];
    let startWaypoint = null;
    let endWaypoint = null;

    function handleError(error) {
      console.error("Error loading model:", error);
      alert("Oops! There was an error loading the model. Please try again later.");
    }

    function loadGltfModel() {
      const loader = new THREE.GLTFLoader();
      loader.load(
        'https://NoopurTyagi.github.io/mymodel4.gltf',
        (gltf) => {
          scene.add(gltf.scene);
          console.log('Model loaded successfully');
          loadWaypoints(); // Load waypoints after model is loaded
        },
        undefined,
        handleError
      );
    }

    function loadWaypoints() {
      const waypointList = document.getElementById('waypoint-list');

      waypoints.forEach(waypoint => {
        waypointMap[waypoint.id] = waypoint;

        const markerGeometry = new THREE.SphereGeometry(0.1, 32, 32);
        const markerMaterial = new THREE.MeshBasicMaterial({ color: waypoint.id === 1 ? 0x00ff00 : 0xff0000 });
        const marker = new THREE.Mesh(markerGeometry, markerMaterial);
        marker.position.set(waypoint.x, waypoint.y, waypoint.z);
        marker.name = waypoint.name;
        marker.userData.id = waypoint.id;
        scene.add(marker);
        markers.push(marker);

        const listItem = document.createElement('li');
        listItem.textContent = waypoint.name; // Display waypoint name
        listItem.style.cursor = 'pointer';
        listItem.onclick = () => {
          selectWaypoint(waypoint.id);
        };
        waypointList.appendChild(listItem);

        console.log(`Waypoint added: ${waypoint.name} at (${waypoint.x}, ${waypoint.y}, ${waypoint.z})`);
      });
    }

    function selectWaypoint(waypointId) {
      const waypoint = waypointMap[waypointId];
      if (!startWaypoint) {
        startWaypoint = waypoint;
        document.getElementById('start-waypoint').textContent = waypoint.name;
      } else if (!endWaypoint) {
        endWaypoint = waypoint;
        document.getElementById('end-waypoint').textContent = waypoint.name;
        navigateToWaypoints(startWaypoint, endWaypoint);
      }
    }

    function navigateToWaypoints(start, end) {
      const path = findPath(start.id, end.id);
      if (path) {
        console.log(`Path found: ${path.map(id => waypointMap[id].name).join(' -> ')}`);
        visualizePath(path);
      } else {
        console.log(`No path found from ${start.name} to ${end.name}`);
      }
    }

    function findPath(startId, endId) {
      const distances = {};
      const previous = {};
      const queue = [];

      waypoints.forEach(waypoint => {
        distances[waypoint.id] = Infinity;
        previous[waypoint.id] = null;
        queue.push(waypoint.id);
      });

      distances[startId] = 0;

      while (queue.length > 0) {
        queue.sort((a, b) => distances[a] - distances[b]);
        const currentId = queue.shift();

        if (currentId === endId) {
          const path = [];
          let current = endId;
          while (current !== null) {
            path.unshift(current);
            current = previous[current];
          }
          return path;
        }

        waypointMap[currentId].connected.forEach(neighborId => {
          const alt = distances[currentId] + distanceBetween(waypointMap[currentId], waypointMap[neighborId]);
          if (alt < distances[neighborId]) {
            distances[neighborId] = alt;
            previous[neighborId] = currentId;
          }
        });
      }

      return null;
    }

    function distanceBetween(waypoint1, waypoint2) {
      const dx = waypoint2.x - waypoint1.x;
      const dy = waypoint2.y - waypoint1.y;
      const dz = waypoint2.z - waypoint1.z;
      return Math.sqrt(dx * dx + dy * dy + dz * dz);
    }

    function visualizePath(path) {
      lines.forEach(line => scene.remove(line));
      lines = [];

      for (let i = 0; i < path.length - 1; i++) {
        const start = waypointMap[path[i]];
        const end = waypointMap[path[i + 1]];

        const material = new THREE.LineBasicMaterial({ color: 0x0000ff });
        const points = [];
        points.push(new THREE.Vector3(start.x, start.y, start.z));
        points.push(new THREE.Vector3(end.x, end.y, end.z));

        const geometry = new THREE.BufferGeometry().setFromPoints(points);
        const line = new THREE.Line(geometry, material);
        scene.add(line);
        lines.push(line);
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    animate(); // Start animation loop
    loadGltfModel(); // Load GLTF model
  </script>
</body>
</html>
